<div class="ui-container ui-scrollable">
  <section class="ui-card">
    <h3 class="section-title">Registro de Vacas Paridas</h3>

    <form
      [formGroup]="form"
      #formDir="ngForm"
      class="ui-form"
      (ngSubmit)="submit()"
      [class.was-submitted]="formDir.submitted">
      <!-- ===== Identificación ===== -->
      <mat-form-field appearance="fill" class="ui-field ui-field-6">
        <mat-label>Número</mat-label>
        <input matInput formControlName="numero" placeholder="Nro" />
        <mat-error *ngIf="has('numero', 'required')">Requerido</mat-error>
      </mat-form-field>

      <mat-form-field appearance="fill" class="ui-field ui-field-6">
        <mat-label>Nombre</mat-label>
        <input matInput formControlName="nombre" placeholder="Nombre de la vaca" />
        <mat-error *ngIf="has('nombre', 'required')">Requerido</mat-error>
      </mat-form-field>

      <mat-form-field appearance="fill" class="ui-field ui-field-6">
        <mat-label>Fecha Nacimiento</mat-label>
        <input matInput [matDatepicker]="nacPicker" formControlName="fechaNac" />
        <mat-datepicker-toggle matSuffix [for]="nacPicker"></mat-datepicker-toggle>
        <mat-datepicker #nacPicker></mat-datepicker>
      </mat-form-field>

      <mat-form-field appearance="fill" class="ui-field ui-field-6">
        <mat-label>Color</mat-label>
        <input matInput formControlName="color" placeholder="Roja, Pintada, Negra..." />
      </mat-form-field>

      <mat-form-field appearance="fill" class="ui-field ui-field-6">
        <mat-label>Procedencia</mat-label>
        <input matInput formControlName="procedencia" placeholder="Compra, Nacida en finca..." />
      </mat-form-field>

      <mat-form-field appearance="fill" class="ui-field ui-field-6">
        <mat-label>Propietario</mat-label>
        <input matInput formControlName="propietario" placeholder="Nombre del propietario" />
      </mat-form-field>

      <!-- ===== Evento / Ubicación ===== -->
      <mat-form-field appearance="fill" class="ui-field ui-field-6">
        <mat-label>Fecha de Parto</mat-label>
        <input matInput [matDatepicker]="partoPicker" formControlName="fechaParto" />
        <mat-datepicker-toggle matSuffix [for]="partoPicker"></mat-datepicker-toggle>
        <mat-datepicker #partoPicker></mat-datepicker>
        <mat-error *ngIf="has('fechaParto', 'required')">Requerido</mat-error>
      </mat-form-field>

      <mat-form-field appearance="fill" class="ui-field ui-field-6">
        <mat-label>F. Palpación</mat-label>
        <input matInput [matDatepicker]="palpPicker" formControlName="fPalpacion" />
        <mat-datepicker-toggle matSuffix [for]="palpPicker"></mat-datepicker-toggle>
        <mat-datepicker #palpPicker></mat-datepicker>
      </mat-form-field>

      <mat-form-field appearance="fill" class="ui-field ui-field-6">
        <mat-label>Seleccione la finca</mat-label>
        <mat-select formControlName="fincaId">
          <mat-option *ngFor="let f of fincas" [value]="f.id">{{ f.nombre }}</mat-option>
        </mat-select>
        <mat-error *ngIf="has('fincaId', 'required')">Requerido</mat-error>
      </mat-form-field>

      <mat-form-field appearance="fill" class="ui-field ui-field-6">
        <mat-label>Género</mat-label>
        <mat-select formControlName="genero">
          <mat-option value="Hembra">Hembra</mat-option>
          <mat-option value="Macho">Macho</mat-option>
        </mat-select>
        <mat-error *ngIf="has('genero', 'required')">Requerido</mat-error>
      </mat-form-field>

      <mat-form-field appearance="fill" class="ui-field ui-field-6">
        <mat-label>Tipo leche</mat-label>
        <mat-select formControlName="tipoLeche">
          <mat-option *ngFor="let t of tiposLeche" [value]="t">{{ t }}</mat-option>
        </mat-select>
      </mat-form-field>

      <!-- ===== Detalles ===== -->
      <mat-form-field appearance="fill" class="ui-field-full">
        <mat-label>Detalles</mat-label>
        <textarea matInput formControlName="detalles" rows="3"></textarea>
      </mat-form-field>

      <!-- ===== Acciones ===== -->
      <div class="ui-actions ui-field-full">
        <button class="ui-btn" style="background: var(--primary)" mat-flat-button type="button">Cancelar</button>
        <button class="ui-btn" style="background: var(--primary)" mat-flat-button type="submit">Guardar</button>
      </div>
    </form>
  </section>
  <!-- ======= Tabla de Vacas (debajo del registro) ======= -->
  <section class="ui-card brand-surface mt-3"  [class.is-compact]="dense">
    <div class="mb-3 flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
      <div class="flex items-center gap-3">
        <span
          class="inline-flex items-center rounded-full px-2.5 py-1 text-xs font-medium"
          style="background: var(--table-head-bg); color: var(--table-ink); border: 1px solid var(--table-border)">
          TOTAL: {{ dataSource.filteredData.length }} / {{ totalVacas }}
        </span>
      </div>

      <div class="flex flex-col gap-2 md:flex-row md:items-center">

        <!-- Búsqueda -->
        <mat-form-field appearance="outline" class="ui-search no-ripple w-full md:w-80">
          <mat-label>Buscar Nº / Nombre / Propietario</mat-label>
          <input matInput [formControl]="qCtrl" placeholder="Ej: 10, Pajarito, Juan..." />
          <button mat-icon-button matSuffix aria-label="clear" (click)="qCtrl.setValue('')">
            <mat-icon>search</mat-icon>
          </button>
        </mat-form-field>

        <!-- Columnas -->
        <button mat-button [matMenuTriggerFor]="colsMenu" class="ui-btn ui-btn-outline">
          <mat-icon class="mr-1">view_column</mat-icon> Columnas
        </button>
        <mat-menu #colsMenu="matMenu">
          <button mat-menu-item *ngFor="let c of allColumns">
            <mat-checkbox [checked]="displayedColumns.includes(c.key)" (change)="toggleColumn(c.key, $event.checked)">
              {{ c.label }}
            </mat-checkbox>
          </button>
        </mat-menu>
      </div>
    </div>

    <div class="ui-table-wrapper">
      <table mat-table [dataSource]="dataSource" matSort class="mat-elevation-z1 ui-table">
        <!-- Índice (sticky izquierda) -->
        <ng-container matColumnDef="idx">
          <th mat-header-cell *matHeaderCellDef class="col-sticky" mat-sort-header>#</th>
          <td mat-cell *matCellDef="let r; let i = index" class="col-sticky">
            {{ paginator.pageIndex * paginator.pageSize + i + 1 }}
          </td>
        </ng-container>

        <!-- Nº -->
        <ng-container matColumnDef="numero">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Nº</th>
          <td mat-cell *matCellDef="let r">
            <strong>{{ r.numero }}</strong>
          </td>
        </ng-container>

        <!-- Nombre -->
        <ng-container matColumnDef="nombre">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>NOMBRE</th>
          <td mat-cell *matCellDef="let r">{{ r.nombre }}</td>
        </ng-container>

        <!-- Nacimiento -->
        <ng-container matColumnDef="fechaNac">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>NACIMIENTO</th>
          <td mat-cell *matCellDef="let r">{{ r.fechaNac | date : 'yyyy-MM-dd' }}</td>
        </ng-container>

        <!-- Color -->
        <ng-container matColumnDef="color">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>COLOR</th>
          <td mat-cell *matCellDef="let r">{{ r.color }}</td>
        </ng-container>

        <!-- Leche -->
        <ng-container matColumnDef="tipoLeche">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>LECHE</th>
          <td mat-cell *matCellDef="let r">{{ r.tipoLeche }}</td>
        </ng-container>

        <!-- Procedencia -->
        <ng-container matColumnDef="procedencia">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>PROCEDENCIA</th>
          <td mat-cell *matCellDef="let r">{{ r.procedencia }}</td>
        </ng-container>

        <!-- Propietario -->
        <ng-container matColumnDef="propietario">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>PROPIETARIO</th>
          <td mat-cell *matCellDef="let r">{{ r.propietario }}</td>
        </ng-container>

        <!-- D.P -->
        <ng-container matColumnDef="dp">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>D.P</th>
          <td mat-cell *matCellDef="let r">{{ r.dp }}</td>
        </ng-container>

        <!-- F. Palpación -->
        <ng-container matColumnDef="fPalpacion">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>F.PALPACIÓN</th>
          <td mat-cell *matCellDef="let r">{{ r.fPalpacion | date : 'dd-MM-yyyy' }}</td>
        </ng-container>

        <!-- Fec. Parto -->
        <ng-container matColumnDef="fechaParto">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>FEC.PARTO</th>
          <td mat-cell *matCellDef="let r">{{ r.fechaParto | date : 'dd-MM-yyyy' }}</td>
        </ng-container>

        <!-- G.C -->
        <ng-container matColumnDef="gc">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>G.C</th>
          <td mat-cell *matCellDef="let r">{{ r.gc }}</td>
        </ng-container>

        <!-- Detalles -->
        <ng-container matColumnDef="detalles">
          <th mat-header-cell *matHeaderCellDef>DETALLES</th>
          <td mat-cell *matCellDef="let r">
            <span class="line-clamp-1" [matTooltip]="r.detalles || ''">{{ r.detalles }}</span>
          </td>
        </ng-container>

        <!-- Acciones -->
        <ng-container matColumnDef="acciones">
          <th mat-header-cell *matHeaderCellDef class="text-right">EDITAR</th>
          <td mat-cell *matCellDef="let r" class="text-right">
            <button mat-icon-button color="primary" (click)="verDetalle(r)" matTooltip="Detalles">
              <mat-icon>visibility</mat-icon>
            </button>
            <button mat-icon-button color="accent" (click)="editar(r)" matTooltip="Editar">
              <mat-icon>edit</mat-icon>
            </button>
          </td>
        </ng-container>

        <!-- Filas / Header -->
        <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns; trackBy: trackById"></tr>

      </table>

      <mat-paginator #paginator [pageSize]="10" [pageSizeOptions]="[5, 10, 20, 50]" showFirstLastButtons>
      </mat-paginator>
    </div>
  </section>
</div>
