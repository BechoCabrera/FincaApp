<div class="ui-container ui-scrollable">
  <!-- ================= FORMULARIO ================= -->
  <section class="ui-card">
    <h3 class="section-title">Registro de Vacas Paridas</h3>

    <form [formGroup]="form" class="ui-form" (ngSubmit)="submit()">
      <!-- ===== Identificaci贸n ===== -->
      <mat-form-field appearance="fill" class="ui-field ui-field-6">
        <mat-label>N煤mero</mat-label>
        <input matInput formControlName="numero" />
        <mat-error *ngIf="form.controls.numero.invalid && form.controls.numero.touched"> Requerido </mat-error>
      </mat-form-field>

      <mat-form-field appearance="fill" class="ui-field ui-field-6">
        <mat-label>Nombre</mat-label>
        <input matInput formControlName="nombre" />
        <mat-error *ngIf="form.controls.nombre.invalid && form.controls.nombre.touched"> Requerido </mat-error>
      </mat-form-field>

      <!-- ===== Fechas ===== -->
      <mat-form-field appearance="fill" class="ui-field ui-field-6">
        <mat-label>Fecha Nacimiento</mat-label>
        <input matInput [matDatepicker]="nacPicker" formControlName="fechaNacimiento" />
        <mat-datepicker-toggle matSuffix [for]="nacPicker"></mat-datepicker-toggle>
        <mat-datepicker #nacPicker></mat-datepicker>
      </mat-form-field>

      <mat-form-field appearance="fill" class="ui-field ui-field-6">
        <mat-label>Color</mat-label>
        <input matInput formControlName="color" />
      </mat-form-field>

      <mat-form-field appearance="fill" class="ui-field ui-field-6">
        <mat-label>Procedencia</mat-label>
        <input matInput formControlName="procedencia" />
      </mat-form-field>

      <mat-form-field appearance="fill" class="ui-field ui-field-6">
        <mat-label>Propietario</mat-label>
        <input matInput formControlName="propietario" />
      </mat-form-field>

      <!-- ===== Evento ===== -->
      <mat-form-field appearance="fill" class="ui-field ui-field-6">
        <mat-label>Fecha de Parto</mat-label>
        <input matInput [matDatepicker]="partoPicker" formControlName="fechaParida" />
        <mat-datepicker-toggle matSuffix [for]="partoPicker"></mat-datepicker-toggle>
        <mat-datepicker #partoPicker></mat-datepicker>
        <mat-error *ngIf="form.controls.fechaParida.invalid && form.controls.fechaParida.touched">
          Requerido
        </mat-error>
      </mat-form-field>

      <mat-form-field appearance="fill" class="ui-field ui-field-6">
        <mat-label>Fecha Palpaci贸n</mat-label>
        <input matInput [matDatepicker]="palpPicker" formControlName="fechaPalpacion" />
        <mat-datepicker-toggle matSuffix [for]="palpPicker"></mat-datepicker-toggle>
        <mat-datepicker #palpPicker></mat-datepicker>
      </mat-form-field>

      <mat-form-field appearance="fill" class="ui-field ui-field-6">
        <mat-label>Finca</mat-label>
        <mat-select formControlName="fincaId">
          <mat-option *ngFor="let f of fincas" [value]="f.id">
            {{ f.nombre }}
          </mat-option>
        </mat-select>
        <mat-error *ngIf="form.controls.fincaId.invalid && form.controls.fincaId.touched"> Requerido </mat-error>
      </mat-form-field>

      <mat-form-field appearance="fill" class="ui-field ui-field-6">
        <mat-label>G茅nero Cr铆a</mat-label>
        <mat-select formControlName="generoCria">
          <mat-option value="Hembra">Hembra</mat-option>
          <mat-option value="Macho">Macho</mat-option>
        </mat-select>
        <mat-error *ngIf="form.controls.generoCria.invalid && form.controls.generoCria.touched"> Requerido </mat-error>
      </mat-form-field>

      <mat-form-field appearance="fill" class="ui-field ui-field-6">
        <mat-label>Tipo de Leche</mat-label>
        <mat-select formControlName="tipoLeche">
          <mat-option *ngFor="let t of tiposLeche" [value]="t">
            {{ t }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <!-- ===== Observaciones ===== -->
      <mat-form-field appearance="fill" class="ui-field-full">
        <mat-label>Observaciones</mat-label>
        <textarea matInput rows="3" formControlName="observaciones"></textarea>
      </mat-form-field>

      <!-- ===== Acciones ===== -->
      <div class="ui-actions ui-field-full">
        <button mat-flat-button type="button" class="ui-btn ui-btn-primary-cancel">Cancelar</button>
        <button mat-flat-button type="submit" class="ui-btn ui-btn-primary">Guardar</button>
      </div>
    </form>
  </section>

  <!-- ================= TABLA ================= -->
  <section class="ui-card brand-surface mt-3">
    <div class="ui-table-wrapper">
      <div class="mb-3 flex flex-col gap-2 md:flex-row md:items-center md:justify-between">
        <div class="flex items-center gap-3">
          <span
            class="inline-flex items-center rounded-full px-2.5 py-1 text-xs font-medium"
            style="background: var(--table-head-bg); color: var(--table-ink); border: 1px solid var(--table-border)">
            TOTAL: {{ dataSource.filteredData.length }}
          </span>
        </div>

        <div class="flex flex-col gap-2 md:flex-row md:items-center">
          <!--  BUSCAR -->
          <mat-form-field appearance="outline" class="ui-search no-ripple w-full md:w-60">
            <mat-label>Buscar N潞 / Nombre / Propietario</mat-label>
            <input matInput [formControl]="qCtrl" />
            <button mat-icon-button matSuffix (click)="qCtrl.setValue('')">
              <mat-icon>search</mat-icon>
            </button>
          </mat-form-field>

          <!--  COLUMNAS -->
          <button mat-flat-button [matMenuTriggerFor]="colsMenu" class="ui-btn" style="background: var(--primary)">
            <mat-icon class="mr-1">view_column</mat-icon>
            Columnas
          </button>

          <!--  PDF -->
          <button
            mat-mini-fab
            class="ui-fab-pdf"
            style="background: var(--primary)"
            (click)="exportPdf()"
            matTooltip="Exportar a PDF">
            <mat-icon>picture_as_pdf</mat-icon>
          </button>

          <mat-menu #colsMenu="matMenu" xPosition="before">
            <button mat-menu-item>
              <mat-checkbox [checked]="allSelected" [indeterminate]="someSelected" (change)="toggleAll($event.checked)">
                Seleccionar todo
              </mat-checkbox>
            </button>

            <mat-divider></mat-divider>

            <button mat-menu-item *ngFor="let c of allColumns">
              <mat-checkbox [checked]="isColumnVisible(c.key)" (change)="toggleColumn(c.key, $event.checked)">
                {{ c.label }}
              </mat-checkbox>
            </button>
          </mat-menu>
        </div>
      </div>

      <table mat-table [dataSource]="dataSource" matSort class="mat-elevation-z1 ui-table" [trackBy]="trackById">
        <!-- N潞 -->
        <!-- ndice -->
        <ng-container matColumnDef="idx">
          <th mat-header-cell *matHeaderCellDef>#</th>
          <td mat-cell *matCellDef="let r; let i = index">
            {{ i + 1 }}
          </td>
        </ng-container>
        <ng-container matColumnDef="numero">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>N潞</th>
          <td mat-cell *matCellDef="let r">{{ r.numero }}</td>
        </ng-container>

        <!-- Nombre -->
        <ng-container matColumnDef="nombre">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Nombre</th>
          <td mat-cell *matCellDef="let r">{{ r.nombre }}</td>
        </ng-container>

        <!-- Fecha Nacimiento -->
        <ng-container matColumnDef="fechaNacimiento">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Nacimiento</th>
          <td mat-cell *matCellDef="let r">
            {{ r.fechaNacimiento | date : 'yyyy-MM-dd' }}
          </td>
        </ng-container>

        <!-- Fecha Parto -->
        <ng-container matColumnDef="fechaParida">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Parto</th>
          <td mat-cell *matCellDef="let r">
            {{ r.fechaParida | date : 'dd-MM-yyyy' }}
          </td>
        </ng-container>

        <!-- Fecha Palpaci贸n -->
        <ng-container matColumnDef="fechaPalpacion">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Palpaci贸n</th>
          <td mat-cell *matCellDef="let r">
            {{ r.fechaPalpacion | date : 'dd-MM-yyyy' }}
          </td>
        </ng-container>

        <!-- Tipo Leche -->
        <ng-container matColumnDef="tipoLeche">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Leche</th>
          <td mat-cell *matCellDef="let r">{{ r.tipoLeche }}</td>
        </ng-container>

        <!-- Procedencia -->
        <ng-container matColumnDef="procedencia">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Procedencia</th>
          <td mat-cell *matCellDef="let r">{{ r.procedencia }}</td>
        </ng-container>

        <!-- Propietario -->
        <ng-container matColumnDef="propietario">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Propietario</th>
          <td mat-cell *matCellDef="let r">{{ r.propietario }}</td>
        </ng-container>

        <!-- Observaciones -->
        <ng-container matColumnDef="observaciones">
          <th mat-header-cell *matHeaderCellDef>Observaciones</th>
          <td mat-cell *matCellDef="let r">
            {{ r.observaciones }}
          </td>
        </ng-container>

        <ng-container matColumnDef="color">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>COLOR</th>
          <td mat-cell *matCellDef="let r">{{ r.color }}</td>
        </ng-container>

        <!-- Acciones -->
        <ng-container matColumnDef="acciones">
          <th mat-header-cell *matHeaderCellDef class="text-right">Acciones</th>
          <td mat-cell *matCellDef="let r" class="text-right">
            <!-- Editar -->
            <button mat-icon-button color="primary" (click)="editar(r)" matTooltip="Editar">
              <mat-icon>edit</mat-icon>
            </button>

            <!-- Eliminar -->
            <button mat-icon-button color="warn" (click)="eliminar(r)" matTooltip="Eliminar">
              <mat-icon>delete</mat-icon>
            </button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
      </table>

      <mat-paginator [pageSize]="10" [pageSizeOptions]="[5, 10, 20, 50]" showFirstLastButtons> </mat-paginator>
    </div>
  </section>
</div>
