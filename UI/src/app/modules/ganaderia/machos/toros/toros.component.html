<div class="ui-container ui-scrollable">
  <section class="ui-card">
    <h3 class="section-title">Registro Toro</h3>

    <form [formGroup]="form" class="ui-form">
      <!-- fila 1 (origen de datos) -->
      <mat-form-field appearance="fill" class="ui-field ui-field-6">
        <mat-label>Tipo de registro</mat-label>
        <mat-select [formControl]="sourceTypeCtrl">
          <mat-option value="">— Seleccione —</mat-option>
          <mat-option *ngFor="let t of sourceTypes" [value]="t.key">{{ t.label }}</mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="fill" class="ui-field ui-field-6">
        <mat-label>Registro</mat-label>
        <mat-select [formControl]="sourceIdCtrl">
          <mat-option value="">— Seleccione —</mat-option>
          <mat-option *ngIf="isLoadingSourceList" [disabled]="true">Cargando...</mat-option>
          <mat-option *ngFor="let r of sourceItems" [value]="r.id">{{ r.nombre }}</mat-option>
        </mat-select>
      </mat-form-field>

      <!-- fila 2 -->
      <mat-form-field appearance="fill" class="ui-field ui-field-6">
        <mat-label>Nombre</mat-label>
        <input matInput formControlName="nombre" placeholder="Nombre del toro" />
        <mat-error *ngIf="has('nombre', 'required')">Requerido</mat-error>
      </mat-form-field>

      <!-- fila 3 -->
      <mat-form-field appearance="fill" class="ui-field ui-field-6">
        <mat-label>Color</mat-label>
        <input matInput formControlName="color" placeholder="Color del toro" />
      </mat-form-field>

      <mat-form-field appearance="fill" class="ui-field ui-field-6">
        <mat-label>Propietario</mat-label>
        <input matInput formControlName="propietario" placeholder="Nombre del propietario" />
      </mat-form-field>

      <!-- fila 4 -->
      <mat-form-field appearance="fill" class="ui-field ui-field-6">
        <mat-label>Peso en kg</mat-label>
        <input matInput type="number" formControlName="pesoKg" placeholder="Ej: 485" />
      </mat-form-field>
      <!-- fila 5 -->
      <mat-form-field appearance="fill" class="ui-field ui-field-6">
        <mat-label>Madre</mat-label>
        <mat-select formControlName="madreId">
          <mat-option [value]="null">— Seleccione —</mat-option>
          <mat-option *ngFor="let m of madres" [value]="m.id"> {{ m.numero }} - {{ m.nombre }} </mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="fill" class="ui-field ui-field-6">
        <mat-label>Finca</mat-label>
        <mat-select formControlName="fincaId">
          <mat-option [value]="null">— Seleccione —</mat-option>
          <mat-option *ngFor="let f of fincas" [value]="f.id">
            {{ f.nombre }}
          </mat-option>
        </mat-select>
        <mat-error *ngIf="has('fincaId', 'required')">Requerido</mat-error>
      </mat-form-field>

      <mat-form-field appearance="fill" class="ui-field ui-field-6">
        <mat-label>Fecha Destete</mat-label>
        <input matInput [matDatepicker]="destetePicker" formControlName="fechaDestete" />
        <mat-datepicker-toggle matSuffix [for]="destetePicker"></mat-datepicker-toggle>
        <mat-datepicker #destetePicker></mat-datepicker>
      </mat-form-field>

 <mat-form-field appearance="fill" class="ui-field ui-field-6">
        <mat-label>Fecha Nacimiento</mat-label>
        <input matInput [matDatepicker]="fnacimientoPicker" formControlName="fechaNac"/>
        <mat-datepicker-toggle matSuffix [for]="fnacimientoPicker"></mat-datepicker-toggle>
        <mat-datepicker #fnacimientoPicker></mat-datepicker>
      </mat-form-field>

      <!-- detalles -->
      <mat-form-field appearance="fill" class="ui-field-full">
        <mat-label>Detalles</mat-label>
        <textarea matInput formControlName="detalles" rows="3"></textarea>
      </mat-form-field>

      <!-- acciones -->
      <div class="ui-actions ui-field-full">
        <button class="ui-btn" style="background: var(--primary)" mat-flat-button type="button">Cancelar</button>
        <button
          mat-flat-button
          type="button"
          style="background: var(--primary)"
          [disabled]="!formOk() || isSaving()"
          (click)="guardarToro()">
          Guardar
        </button>
      </div>
    </form>
  </section>

  <!-- ===== tabla ===== -->
  <section class="ui-card brand-surface mt-3" [class.is-compact]="dense">
    <app-table-filters
      [qControl]="qCtrl"
      [fincaControl]="fincaCtrl"
      [fincas]="fincas"
      [totalLabel]="'TOTAL DE TOROS: ' + dataSource.filteredData.length + ' / ' + totalToros"
      [allColumns]="allColumns"
      [displayedColumns]="displayedColumns"
      [allSelected]="allSelected"
      [someSelected]="someSelected"
      (toggleColumn)="toggleColumn($event.key, $event.checked)"
      (toggleAll)="toggleAll($event)"
      (exportPdf)="exportPdf()"
    ></app-table-filters>

    <div class="ui-table-wrapper">
      <table mat-table [dataSource]="dataSource" matSort class="mat-elevation-z1 ui-table" [trackBy]="trackById">
        <!-- índice -->
        <ng-container matColumnDef="idx">
          <th mat-header-cell *matHeaderCellDef class="col-sticky" mat-sort-header>#</th>
          <td mat-cell *matCellDef="let r; let i = index" class="col-sticky">
            {{ paginator.pageIndex * paginator.pageSize + i + 1 }}
          </td>
        </ng-container>

        <ng-container matColumnDef="pesoKg">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Peso Kg</th>
          <td mat-cell *matCellDef="let r">
            <strong>{{ r.pesoKg }}</strong>
          </td>
        </ng-container>

        <ng-container matColumnDef="nombre">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>NOMBRE</th>
          <td mat-cell *matCellDef="let r">{{ r.nombre }}</td>
        </ng-container>

        <ng-container matColumnDef="color">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>COLOR</th>
          <td mat-cell *matCellDef="let r">{{ r.color }}</td>
        </ng-container>

        <ng-container matColumnDef="propietario">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>PROPIETARIO</th>
          <td mat-cell *matCellDef="let r">{{ r.propietario }}</td>
        </ng-container>

        <ng-container matColumnDef="madreNumero">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>N° MAMA</th>
          <td mat-cell *matCellDef="let r">{{ r.madreNumero }}</td>
        </ng-container>
        <ng-container matColumnDef="madreNombre">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>MAMA</th>
          <td mat-cell *matCellDef="let r">{{ r.madreNombre }}</td>
        </ng-container>

        <ng-container matColumnDef="fechaDestete">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>FEC. DESTETE</th>
          <td mat-cell *matCellDef="let r">{{ r.fechaDestete | date : 'yyyy-MM-dd' }}</td>
        </ng-container>

        <ng-container matColumnDef="fechaNac">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>FEC. NACIMIENTO</th>
          <td mat-cell *matCellDef="let r">{{ r.fechaNac | date : 'yyyy-MM-dd' }}</td>
        </ng-container>

        <ng-container matColumnDef="detalles">
          <th mat-header-cell *matHeaderCellDef>DETALLES</th>
          <td mat-cell *matCellDef="let r">
            <span class="line-clamp-1" [matTooltip]="r.detalles || ''">{{ r.detalles }}</span>
          </td>
        </ng-container>

        <ng-container matColumnDef="acciones">
          <th mat-header-cell *matHeaderCellDef class="text-right">ACCIONES</th>
          <td mat-cell *matCellDef="let r" class="text-right">
            <button mat-icon-button color="primary" (click)="editar(r)" matTooltip="Editar">
              <mat-icon>edit</mat-icon>
            </button>
            <button mat-icon-button color="warn" (click)="eliminar(r)" matTooltip="Eliminar">
              <mat-icon>delete</mat-icon>
            </button>
          </td>
        </ng-container>
        <!-- filas -->
        <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
      </table>

      <mat-paginator
        #paginator
        [pageSize]="10"
        [pageSizeOptions]="[5, 10, 20, 50]"
        showFirstLastButtons></mat-paginator>
    </div>
  </section>
</div>
